<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Crop Fixed Size & Compress</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    #preview {
        width: 100%;
        height: 200px;
        object-fit: contain;
    }
    .crop-container {
        position: relative;
        width: 500px;
        height: 500px;
        margin: 0 auto;
        overflow: hidden;
        background: #f0f0f0;
    }
    .crop-box {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300px;
        height: 400px;
        border: 2px solid red;
        transform: translate(-50%, -50%);
        pointer-events: none;
    }
    #resizeHandle {
        position: absolute;
        width: 12px;
        height: 12px;
        background: red;
        border-radius: 50%;
        bottom: 0;
        right: 0;
        cursor: nwse-resize;
    }
    #image {
        position: absolute;
        cursor: grab;
        user-select: none;
    }
</style>
</head>
<body>

<div class="container mt-5 text-center">
    <div class="card shadow-sm">
        <div class="card-body">
            <form id="uploadForm" action="store.php" method="POST" enctype="multipart/form-data">
                <picture>
                    <img id="preview" src="../../public/defualt/defualt.jpg" alt="">
                </picture><br>
                <label class="form-label mt-3">Select Image</label>
                <input type="file" id="imageInput" name="image" class="form-control">
            </form>
        </div>
        <div class="mt-3 text-start">
            <p>Weight: <span id="imgWeight">0 KB</span></p>
            <p>Size: <span id="imgSize">0 Ã— 0</span></p>
            <p id="errorMsg" class="text-danger"></p>
        </div>
    </div>
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crop Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="crop-container">
                    <img id="image">
                    <div class="crop-box"></div>
                    <div id="resizeHandle"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cropBtn" class="btn btn-primary">Crop & Compress</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ====================== ELEMENTS ======================
        const input = document.getElementById("imageInput");
        const image = document.getElementById("image");
        const preview = document.getElementById("preview");
        const cropBtn = document.getElementById("cropBtn");
        const imgWeight = document.getElementById("imgWeight");
        const imgSize = document.getElementById("imgSize");
        const errorMsg = document.getElementById("errorMsg");
        const modalEl = document.getElementById('cropModal');
        const modal = new bootstrap.Modal(modalEl);
        const handle = document.getElementById('resizeHandle');

        // Drag & Resize variables
        let isDragging = false,
            startX, startY, imgX, imgY;
        let isResizing = false;
        let currentLeft = 0,
            currentTop = 0,
            currentWidth = 0,
            currentHeight = 0;

        // ====================== LOAD IMAGE ======================
        input.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            image.src = url;

            image.onload = () => {
                currentWidth = image.naturalWidth > 500 ? 500 : image.naturalWidth;
                currentHeight = image.naturalHeight > 500 ? 500 : image.naturalHeight;
                currentLeft = (500 - currentWidth) / 2;
                currentTop = (500 - currentHeight) / 2;

                image.style.width = currentWidth + "px";
                image.style.height = currentHeight + "px";
                image.style.left = currentLeft + "px";
                image.style.top = currentTop + "px";
            };

            modal.show();
        });

        // ====================== DRAG IMAGE ======================
        image.addEventListener('mousedown', e => {
            if (e.target === handle) return;
            e.preventDefault();
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            imgX = parseFloat(image.style.left);
            imgY = parseFloat(image.style.top);
            image.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', e => {
            if (isDragging) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                currentLeft = imgX + dx;
                currentTop = imgY + dy;

                image.style.left = currentLeft + "px";
                image.style.top = currentTop + "px";
            }

            if (isResizing) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                currentWidth += dx;
                currentHeight += dy;

                if (currentWidth < 20) currentWidth = 20;
                if (currentHeight < 20) currentHeight = 20;

                image.style.width = currentWidth + "px";
                image.style.height = currentHeight + "px";

                startX = e.clientX;
                startY = e.clientY;
            }
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
            image.style.cursor = 'grab';
        });

        // ====================== RESIZE HANDLE ======================
        handle.addEventListener('mousedown', e => {
            e.preventDefault();
            e.stopPropagation();
            isResizing = true;
            startX = e.clientX;
            startY = e.clientY;
        });


        // ====================== CROP & COMPRESS ======================
        cropBtn.addEventListener('click', () => {

            const container = image.parentElement;
            const cropBox = container.querySelector('.crop-box');

            const imgRect = image.getBoundingClientRect();
            const cropRect = cropBox.getBoundingClientRect();

            const scaleX = image.naturalWidth / imgRect.width;
            const scaleY = image.naturalHeight / imgRect.height;

            const cropX = (cropRect.left - imgRect.left) * scaleX;
            const cropY = (cropRect.top - imgRect.top) * scaleY;
            const cropWidth = cropRect.width * scaleX;
            const cropHeight = cropRect.height * scaleY;

            const outputWidth = 150;
            const outputHeight = 200;

            const canvas = document.createElement('canvas');
            canvas.width = outputWidth;
            canvas.height = outputHeight;
            const ctx = canvas.getContext('2d');

            ctx.drawImage(image, cropX, cropY, cropWidth, cropHeight, 0, 0, outputWidth, outputHeight);

            // compress function
            function compress(canvas, maxSizeKB, quality = 0.9) {
                return new Promise(resolve => {
                    function step(q) {
                        canvas.toBlob(blob => {
                            if (blob.size / 1024 <= maxSizeKB || q <= 0.1) resolve(blob);
                            else step(q - 0.05);
                        }, 'image/jpeg', q);
                    }
                    step(quality);
                });
            }

            compress(canvas, 250).then(blob => {

                // Preview
                preview.src = URL.createObjectURL(blob);

                const file = new File([blob], "cropped.jpg", {
                    type: "image/jpeg"
                });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input.files = dataTransfer.files;

                modal.hide();
            });

        });
    </script>

</body>
</html>
